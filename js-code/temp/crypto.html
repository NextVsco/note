<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="description" content="加密解密数据">
  <title>Web Crypto API example</title>
  <style>
    /* General setup */

    * {
      box-sizing: border-box;
    }

    html,
    body {
      font-family: sans-serif;
      line-height: 1.2rem;
    }

    /* Layout and styles */

    h1 {
      color: green;
      margin-left: .5rem;
    }

    .description,
    .encrypt-decrypt {
      margin: 0 .5rem;
    }

    .description>p {
      margin-top: 0;
    }

    .encrypt-decrypt {
      box-shadow: -1px 2px 5px gray;
      padding: .2rem .5rem;
      margin-bottom: 2rem;
    }

    .encrypt-decrypt-controls>* {
      margin: .5rem 0;
    }

    input[type="button"] {
      width: 5rem;
    }

    .ciphertext-value,
    .decrypted-value {
      padding-left: .5rem;
      font-family: monospace;
    }

    /* Whole page grid */
    main {
      display: grid;
      grid-template-columns: 32rem 1fr;
      grid-template-rows: 4rem 1fr;
    }

    h1 {
      grid-column: 1/2;
      grid-row: 1;
    }

    .examples {
      grid-column: 1;
      grid-row: 2;
    }

    .description {
      grid-column: 2;
      grid-row: 2;
    }

    /* encrypt-decrypt controls grid */
    .encrypt-decrypt-controls {
      display: grid;
      grid-template-columns: 1fr 5rem;
      grid-template-rows: 1fr 1fr 1fr;
    }

    .message-control {
      grid-column-start: 1;
      grid-row-start: 1;
    }

    .ciphertext {
      grid-column-start: 1;
      grid-row-start: 2;
    }

    .decrypted {
      grid-column-start: 1;
      grid-row-start: 3;
    }

    .encrypt-button {
      grid-column-start: 2;
      grid-row-start: 1;
    }

    .decrypt-button {
      grid-column-start: 2;
      grid-row-start: 2;
    }

    /* Animate output display */
    .fade-in {
      animation: fadein .5s;
    }

    @keyframes fadein {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <main>
    <h1>Web Crypto: encrypt/decrypt</h1>

    <section class="description">
      <p>This page shows the use of the <code>encrypt()</code> and <code>decrypt()</code> functions of the <a
          href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API">Web Crypto API</a>. It contains four
        separate examples, one for each encryption algorithm supported:</p>
      <ul>
        <li>"RSA-OAEP"</li>
        <li>"AES-CTR"</li>
        <li>"AES-CBC"</li>
        <li>"AES-GCM"</li>
      </ul>
      <hr />
      <p>Each example has five components:</p>
      <ul>
        <li>A text box containing a message to encrypt.</li>
        <li>A representation of the ciphertext.</li>
        <li>A box that will contain the decrypted ciphertext.</li>
        <li>An "Encrypt" button: this encrypts the text box contents, displays part of the ciphertext, and stores the
          complete ciphertext.</li>
        <li>A "Decrypt" button: this decrypts the ciphertext and writes the result into the "Decrypted" box.</li>
      </ul>
      <p>Try it:</p>
      <ul>
        <li>Press "Encrypt". The ciphertext should appear.</li>
        <li>Press "Decrypt". The decrypted text should appear, and match the original message.</li>
        <li>Edit the text box contents.</li>
        <li>Press "Encrypt" again. A different ciphertext should appear.</li>
        <li>Press "Decrypt" again. The new text box contents should appear next to "Decrypted:".</li>
      </ul>
    </section>

    <section class="examples">
      <section class="encrypt-decrypt rsa-oaep">
        <h2 class="encrypt-decrypt-heading">RSA-OAEP</h2>
        <section class="encrypt-decrypt-controls">
          <div class="message-control">
            <label for="rsa-oaep-message">Enter a message to encrypt:</label>
            <input type="text" id="rsa-oaep-message" name="message" size="25" value="The owl hoots at midnight">
          </div>
          <div class="ciphertext">Ciphertext:<span class="ciphertext-value"></span></div>
          <div class="decrypted">Decrypted:<span class="decrypted-value"></span></div>
          <input class="encrypt-button" type="button" value="Encrypt">
          <input class="decrypt-button" type="button" value="Decrypt">
        </section>
      </section>

      <section class="encrypt-decrypt aes-ctr">
        <h2 class="encrypt-decrypt-heading">AES-CTR</h2>
        <section class="encrypt-decrypt-controls">
          <div class="message-control">
            <label for="aes-ctr-message">Enter a message to encrypt:</label>
            <input type="text" id="aes-ctr-message" name="message" size="25" value="The tiger prowls at dawn">
          </div>
          <div class="ciphertext">Ciphertext:<span class="ciphertext-value"></span></div>
          <div class="decrypted">Decrypted:<span class="decrypted-value"></span></div>
          <input class="encrypt-button" type="button" value="Encrypt">
          <input class="decrypt-button" type="button" value="Decrypt">
        </section>
      </section>

      <section class="encrypt-decrypt aes-cbc">
        <h2 class="encrypt-decrypt-heading">AES-CBC</h2>
        <section class="encrypt-decrypt-controls">
          <div class="message-control">
            <label for="aes-cbc-message">Enter a message to encrypt:</label>
            <input type="text" id="aes-cbc-message" name="message" size="25" value="The eagle flies at twilight">
          </div>
          <div class="ciphertext">Ciphertext:<span class="ciphertext-value"></span></div>
          <div class="decrypted">Decrypted:<span class="decrypted-value"></span></div>
          <input class="encrypt-button" type="button" value="Encrypt">
          <input class="decrypt-button" type="button" value="Decrypt">
        </section>
      </section>

      <section class="encrypt-decrypt aes-gcm">
        <h2 class="encrypt-decrypt-heading">AES-GCM</h2>
        <section class="encrypt-decrypt-controls">
          <div class="message-control">
            <label for="aes-gcm-message">Enter a message to encrypt:</label>
            <input type="text" id="aes-gcm-message" name="message" size="25" value="The bunny hops at teatime">
          </div>
          <div class="ciphertext">Ciphertext:<span class="ciphertext-value"></span></div>
          <div class="decrypted">Decrypted:<span class="decrypted-value"></span></div>
          <input class="encrypt-button" type="button" value="Encrypt">
          <input class="decrypt-button" type="button" value="Decrypt">
        </section>
      </section>

    </section>
  </main>

</body>
<script name="rsa-oaep.js">
  (() => {

    /*
    Store the calculated ciphertext here, so we can decrypt the message later.
    */
    let ciphertext;

    /*
    Fetch the contents of the "message" textbox, and encode it
    in a form we can use for the encrypt operation.
    */
    function getMessageEncoding() {
      const messageBox = document.querySelector("#rsa-oaep-message");
      let message = messageBox.value;
      let enc = new TextEncoder();
      return enc.encode(message);
    }

    /*
    Get the encoded message, encrypt it and display a representation
    of the ciphertext in the "Ciphertext" element.
    */
    async function encryptMessage(key) {
      let encoded = getMessageEncoding();
      ciphertext = await window.crypto.subtle.encrypt({
          name: "RSA-OAEP"
        },
        key,
        encoded
      );

      let buffer = new Uint8Array(ciphertext, 0, 5);
      const ciphertextValue = document.querySelector(".rsa-oaep .ciphertext-value");
      ciphertextValue.classList.add('fade-in');
      ciphertextValue.addEventListener('animationend', () => {
        ciphertextValue.classList.remove('fade-in');
      });
      ciphertextValue.textContent = `${buffer}...[${ciphertext.byteLength} bytes total]`;
    }

    /*
    Fetch the ciphertext and decrypt it.
    Write the decrypted message into the "Decrypted" box.
    */
    async function decryptMessage(key) {
      let decrypted = await window.crypto.subtle.decrypt({
          name: "RSA-OAEP"
        },
        key,
        ciphertext
      );

      let dec = new TextDecoder();
      const decryptedValue = document.querySelector(".rsa-oaep .decrypted-value");
      decryptedValue.classList.add('fade-in');
      decryptedValue.addEventListener('animationend', () => {
        decryptedValue.classList.remove('fade-in');
      });
      decryptedValue.textContent = dec.decode(decrypted);
    }

    /*
    Generate an encryption key pair, then set up event listeners
    on the "Encrypt" and "Decrypt" buttons.
    */
    window.crypto.subtle.generateKey({
        name: "RSA-OAEP",
        // Consider using a 4096-bit key for systems that require long-term security
        modulusLength: 2048,
        publicExponent: new Uint8Array([1, 0, 1]),
        hash: "SHA-256",
      },
      true,
      ["encrypt", "decrypt"]
    ).then((keyPair) => {
      const encryptButton = document.querySelector(".rsa-oaep .encrypt-button");
      encryptButton.addEventListener("click", () => {
        encryptMessage(keyPair.publicKey);
      });

      const decryptButton = document.querySelector(".rsa-oaep .decrypt-button");
      decryptButton.addEventListener("click", () => {
        decryptMessage(keyPair.privateKey);
      });
    });

  })();
</script>
<script name="aes-cbc.js">
  (() => {

    /*
    Store the calculated ciphertext and IV here, so we can decrypt the message later.
    */
    let ciphertext;
    let iv;

    /*
    Fetch the contents of the "message" textbox, and encode it
    in a form we can use for the encrypt operation.
    */
    function getMessageEncoding() {
      const messageBox = document.querySelector("#aes-cbc-message");
      let message = messageBox.value;
      let enc = new TextEncoder();
      return enc.encode(message);
    }

    /*
    Get the encoded message, encrypt it and display a representation
    of the ciphertext in the "Ciphertext" element.
    */
    async function encryptMessage(key) {
      let encoded = getMessageEncoding();
      // The iv must never be reused with a given key.
      iv = window.crypto.getRandomValues(new Uint8Array(16));
      ciphertext = await window.crypto.subtle.encrypt({
          name: "AES-CBC",
          iv
        },
        key,
        encoded
      );

      let buffer = new Uint8Array(ciphertext, 0, 5);
      const ciphertextValue = document.querySelector(".aes-cbc .ciphertext-value");
      ciphertextValue.classList.add('fade-in');
      ciphertextValue.addEventListener('animationend', () => {
        ciphertextValue.classList.remove('fade-in');
      });
      ciphertextValue.textContent = `${buffer}...[${ciphertext.byteLength} bytes total]`;
    }

    /*
    Fetch the ciphertext and decrypt it.
    Write the decrypted message into the "Decrypted" box.
    */
    async function decryptMessage(key) {
      let decrypted = await window.crypto.subtle.decrypt({
          name: "AES-CBC",
          iv
        },
        key,
        ciphertext
      );

      let dec = new TextDecoder();
      const decryptedValue = document.querySelector(".aes-cbc .decrypted-value");
      decryptedValue.classList.add('fade-in');
      decryptedValue.addEventListener('animationend', () => {
        decryptedValue.classList.remove('fade-in');
      });
      decryptedValue.textContent = dec.decode(decrypted);
    }

    /*
    Generate an encryption key, then set up event listeners
    on the "Encrypt" and "Decrypt" buttons.
    */
    window.crypto.subtle.generateKey({
        name: "AES-CBC",
        length: 256
      },
      true,
      ["encrypt", "decrypt"]
    ).then((key) => {
      const encryptButton = document.querySelector(".aes-cbc .encrypt-button");
      encryptButton.addEventListener("click", () => {
        encryptMessage(key);
      });

      const decryptButton = document.querySelector(".aes-cbc .decrypt-button");
      decryptButton.addEventListener("click", () => {
        decryptMessage(key);
      });
    });

  })();
</script>
<script name="aes-ctr.js">
  (() => {

    /*
    Store the calculated ciphertext and counter here, so we can decrypt the message later.
    */
    let ciphertext;
    let counter;

    /*
    Fetch the contents of the "message" textbox, and encode it
    in a form we can use for the encrypt operation.
    */
    function getMessageEncoding() {
      const messageBox = document.querySelector("#aes-ctr-message");
      let message = messageBox.value;
      let enc = new TextEncoder();
      return enc.encode(message);
    }

    /*
    Get the encoded message, encrypt it and display a representation
    of the ciphertext in the "Ciphertext" element.
    */
    async function encryptMessage(key) {
      let encoded = getMessageEncoding();
      // The counter block value must never be reused with a given key.
      counter = window.crypto.getRandomValues(new Uint8Array(16)),
        ciphertext = await window.crypto.subtle.encrypt({
            name: "AES-CTR",
            counter,
            length: 64
          },
          key,
          encoded
        );

      let buffer = new Uint8Array(ciphertext, 0, 5);
      const ciphertextValue = document.querySelector(".aes-ctr .ciphertext-value");
      ciphertextValue.classList.add('fade-in');
      ciphertextValue.addEventListener('animationend', () => {
        ciphertextValue.classList.remove('fade-in');
      });
      ciphertextValue.textContent = `${buffer}...[${ciphertext.byteLength} bytes total]`;
    }

    /*
    Fetch the ciphertext and decrypt it.
    Write the decrypted message into the "Decrypted" box.
    */
    async function decryptMessage(key) {
      let decrypted = await window.crypto.subtle.decrypt({
          name: "AES-CTR",
          counter,
          length: 64
        },
        key,
        ciphertext
      );

      let dec = new TextDecoder();
      const decryptedValue = document.querySelector(".aes-ctr .decrypted-value");
      decryptedValue.classList.add('fade-in');
      decryptedValue.addEventListener('animationend', () => {
        decryptedValue.classList.remove('fade-in');
      });
      decryptedValue.textContent = dec.decode(decrypted);
    }

    /*
    Generate an encryption key, then set up event listeners
    on the "Encrypt" and "Decrypt" buttons.
    */
    window.crypto.subtle.generateKey({
        name: "AES-CTR",
        length: 256
      },
      true,
      ["encrypt", "decrypt"]
    ).then((key) => {
      const encryptButton = document.querySelector(".aes-ctr .encrypt-button");
      encryptButton.addEventListener("click", () => {
        encryptMessage(key);
      });

      const decryptButton = document.querySelector(".aes-ctr .decrypt-button");
      decryptButton.addEventListener("click", () => {
        decryptMessage(key);
      });
    });

  })();
</script>
<script name="aes-gcm.js">
  (() => {

    /*
    Store the calculated ciphertext and IV here, so we can decrypt the message later.
    */
    let ciphertext;
    let iv;

    /*
    Fetch the contents of the "message" textbox, and encode it
    in a form we can use for the encrypt operation.
    */
    function getMessageEncoding() {
      const messageBox = document.querySelector("#aes-gcm-message");
      let message = messageBox.value;
      let enc = new TextEncoder();
      return enc.encode(message);
    }

    /*
    Get the encoded message, encrypt it and display a representation
    of the ciphertext in the "Ciphertext" element.
    */
    async function encryptMessage(key) {
      let encoded = getMessageEncoding();
      // The iv must never be reused with a given key.
      iv = window.crypto.getRandomValues(new Uint8Array(12));
      ciphertext = await window.crypto.subtle.encrypt({
          name: "AES-GCM",
          iv: iv
        },
        key,
        encoded
      );

      let buffer = new Uint8Array(ciphertext, 0, 5);
      const ciphertextValue = document.querySelector(".aes-gcm .ciphertext-value");
      ciphertextValue.classList.add('fade-in');
      ciphertextValue.addEventListener('animationend', () => {
        ciphertextValue.classList.remove('fade-in');
      });
      ciphertextValue.textContent = `${buffer}...[${ciphertext.byteLength} bytes total]`;
    }

    /*
    Fetch the ciphertext and decrypt it.
    Write the decrypted message into the "Decrypted" box.
    */
    async function decryptMessage(key) {
      let decrypted = await window.crypto.subtle.decrypt({
          name: "AES-GCM",
          iv: iv
        },
        key,
        ciphertext
      );

      let dec = new TextDecoder();
      const decryptedValue = document.querySelector(".aes-gcm .decrypted-value");
      decryptedValue.classList.add('fade-in');
      decryptedValue.addEventListener('animationend', () => {
        decryptedValue.classList.remove('fade-in');
      });
      decryptedValue.textContent = dec.decode(decrypted);
    }

    /*
    Generate an encryption key, then set up event listeners
    on the "Encrypt" and "Decrypt" buttons.
    */
    window.crypto.subtle.generateKey({
        name: "AES-GCM",
        length: 256,
      },
      true,
      ["encrypt", "decrypt"]
    ).then((key) => {
      const encryptButton = document.querySelector(".aes-gcm .encrypt-button");
      encryptButton.addEventListener("click", () => {
        encryptMessage(key);
      });

      const decryptButton = document.querySelector(".aes-gcm .decrypt-button");
      decryptButton.addEventListener("click", () => {
        decryptMessage(key);
      });
    });

  })();
</script>

</html>
